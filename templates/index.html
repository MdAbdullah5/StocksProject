<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Company Reports Scraper</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script>
    async function startScraping() {
      const textarea = document.getElementById("urls");
      const urls = textarea.value.split("\n").map(u => u.trim()).filter(u => u);
      const tableBody = document.getElementById("result-body");
      tableBody.innerHTML = "";

      for (let i = 0; i < urls.length; i++) {
        const url = urls[i];

        const loadingRow = document.createElement("tr");
        loadingRow.innerHTML = `<td colspan="11">üîÑ Scraping <strong>${url}</strong>...</td>`;
        tableBody.appendChild(loadingRow);

        try {
          const response = await fetch("/scrape", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ url })
          });
          const result = await response.json();

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${i + 1}</td>
            <td><a href="${result.company_url}" target="_blank">Link</a></td>
            <td>${result.annual_pdf ? `<a href="${result.annual_pdf}" target="_blank">Annual</a>` : '-'}</td>
            <td>${result.annual_text ? result.annual_text.slice(0, 50) + '...' : '-'}</td>
            <td>${result.quarterly_pdf ? `<a href="${result.quarterly_pdf}" target="_blank">Quarterly</a>` : '-'}</td>
            <td>${result.quarterly_text ? result.quarterly_text.slice(0, 50) + '...' : '-'}</td>
            <td>${result.press_release_url ? `<a href="${result.press_release_url}" target="_blank">Press</a>` : '-'}</td>
            <td>${result.press_text ? result.press_text.slice(0, 50) + '...' : '-'}</td>
            <td>${result.start_time}</td>
            <td>${result.end_time}</td>
            <td>${result.status}</td>
          `;

          tableBody.replaceChild(row, loadingRow);
        } catch (err) {
          console.error("Error:", err);
          loadingRow.innerHTML = `<td colspan="11" class="text-danger">‚ùå Failed scraping ${url}</td>`;
        }
      }
    }
  </script>
</head>
<body>
  <div class="container mt-5">
    <h2 class="mb-4">Company Reports Scraper</h2>
    <div class="mb-3">
      <label for="urls" class="form-label">Enter one URL per line:</label>
      <textarea class="form-control" id="urls" rows="5" placeholder="https://example.com"></textarea>
    </div>
    <button onclick="startScraping()" class="btn btn-primary">Start Scraping</button>
    <a href="/download" class="btn btn-secondary ms-2">Download CSV</a>

    <hr>
    <h4>Scraped Results</h4>
    <div class="table-responsive">
      <table class="table table-bordered table-striped align-middle text-sm">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Company URL</th>
            <th>Annual PDF</th>
            <th>Annual Text</th>
            <th>Quarterly PDF</th>
            <th>Quarterly Text</th>
            <th>Press Release</th>
            <th>Press Text</th>
            <th>Start</th>
            <th>End</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="result-body"></tbody>
      </table>
    </div>
  </div>
</body>
</html>
